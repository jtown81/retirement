# PR-006: CSV & Print Export ‚Äî Plan

## Context

We've completed PR-001 through PR-005:
- **PR-001 through PR-003:** Tax module foundation and integration
- **PR-004:** TSP monitoring (balance history, fund allocation, CSV import)
- **PR-005:** Scenario management (save, load, compare)

Now we build the **Export & Reporting** system: users can export their retirement projection table to CSV, JSON, and print-optimized layout. This enables data portability, external analysis, and physical/digital sharing of retirement plans.

**Key capabilities:**
1. Export projection table (40 years of income/expense/tax data) to CSV
2. Export named scenario metadata and inputs to JSON (for backup/sharing)
3. Print-friendly layout with optimized CSS (no nav, forms, interactive elements)
4. PDF generation via browser print dialog
5. Reports dashboard tab with filterable/sortable projection table

---

## Implementation Plan

### Files to Create/Modify

#### 1. `app/src/utils/export.ts` (Create)
**Purpose:** Core export utility functions (CSV, JSON, triggers).

```typescript
import type { SimulationYearResult } from '@models/simulation';
import type { NamedScenario } from '@models/scenario';

/**
 * Export projection table to CSV format
 *
 * CSV columns: Year, Age, Annuity, FERS Supplement, Social Security,
 *              TSP Withdrawal, Gross Income, Federal Tax, State Tax,
 *              IRMAA Surcharge, After-Tax Income, Expenses, Net Surplus, TSP Balance
 */
export function exportProjectionCSV(years: SimulationYearResult[], filename?: string): void {
  const headers = [
    'Year',
    'Age',
    'Annuity',
    'FERS Supplement',
    'Social Security',
    'TSP Withdrawal',
    'Gross Income',
    'Federal Tax',
    'State Tax',
    'IRMAA Surcharge',
    'After-Tax Income',
    'Total Expenses',
    'Net Surplus',
    'TSP Balance (EOY)',
  ];

  const rows = years.map((year) => [
    year.year,
    Math.round(year.age),
    currency(year.annuity),
    currency(year.fersSupplement),
    currency(year.socialSecurity),
    currency(year.tspWithdrawal),
    currency(year.totalIncome),
    currency(year.federalTax),
    currency(year.stateTax),
    currency(year.irmaaSurcharge),
    currency(year.afterTaxIncome),
    currency(year.totalExpenses),
    currency(year.surplus),
    currency(year.totalTSPBalance),
  ]);

  const csvContent = [
    headers.join(','),
    ...rows.map((row) => row.join(',')),
  ].join('\n');

  const defaultFilename = `retirement-projection-${new Date().toISOString().split('T')[0]}.csv`;
  triggerDownload(csvContent, 'text/csv; charset=utf-8', filename ?? defaultFilename);
}

/**
 * Export a single scenario to JSON
 */
export function exportScenarioJSON(scenario: NamedScenario, filename?: string): void {
  const json = JSON.stringify(scenario, null, 2);
  const defaultFilename = `scenario-${scenario.label.replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().split('T')[0]}.json`;
  triggerDownload(json, 'application/json; charset=utf-8', filename ?? defaultFilename);
}

/**
 * Export multiple scenarios to JSON
 */
export function exportScenariosJSON(scenarios: NamedScenario[], filename?: string): void {
  const json = JSON.stringify(scenarios, null, 2);
  const defaultFilename = `scenarios-${new Date().toISOString().split('T')[0]}.json`;
  triggerDownload(json, 'application/json; charset=utf-8', filename ?? defaultFilename);
}

/**
 * Trigger browser download dialog
 *
 * @param content - File content as string
 * @param mimeType - MIME type (e.g., 'text/csv; charset=utf-8')
 * @param filename - Suggested filename for download
 */
export function triggerDownload(content: string, mimeType: string, filename: string): void {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

/**
 * Trigger browser print dialog (uses @media print CSS)
 */
export function triggerPrint(title?: string): void {
  // Optional: set page title for print header
  if (title) {
    const oldTitle = document.title;
    document.title = title;
    window.print();
    document.title = oldTitle;
  } else {
    window.print();
  }
}

// Helper: format number as currency for CSV
function currency(value: number): string {
  return Math.round(value).toLocaleString('en-US');
}
```

---

#### 2. `app/src/components/charts/ProjectionTable.tsx` (Create)
**Purpose:** Full projection table with sorting, pagination, and export button.

**Structure:**

```tsx
import { useState, useMemo } from 'react';
import type { SimulationYearResult } from '@models/simulation';
import { exportProjectionCSV } from '@utils/export';

export interface ProjectionTableProps {
  years: SimulationYearResult[];
  onExportCSV?: () => void;
}

type SortKey = 'year' | 'age' | 'income' | 'tax' | 'afterTax' | 'surplus' | 'balance';
type SortOrder = 'asc' | 'desc';

export function ProjectionTable({ years }: ProjectionTableProps) {
  const [sortKey, setSortKey] = useState<SortKey>('year');
  const [sortOrder, setSortOrder] = useState<SortOrder>('asc');
  const [pageSize, setPageSize] = useState(10);
  const [showAll, setShowAll] = useState(false);

  // Sorting logic
  const sorted = useMemo(() => {
    const copy = [...years];
    copy.sort((a, b) => {
      let aVal: number;
      let bVal: number;

      switch (sortKey) {
        case 'year':
          aVal = a.year;
          bVal = b.year;
          break;
        case 'age':
          aVal = a.age;
          bVal = b.age;
          break;
        case 'income':
          aVal = a.totalIncome;
          bVal = b.totalIncome;
          break;
        case 'tax':
          aVal = a.federalTax + a.stateTax + a.irmaaSurcharge;
          bVal = b.federalTax + b.stateTax + b.irmaaSurcharge;
          break;
        case 'afterTax':
          aVal = a.afterTaxIncome;
          bVal = b.afterTaxIncome;
          break;
        case 'surplus':
          aVal = a.surplus;
          bVal = b.surplus;
          break;
        case 'balance':
          aVal = a.totalTSPBalance;
          bVal = b.totalTSPBalance;
          break;
      }

      return sortOrder === 'asc' ? aVal - bVal : bVal - aVal;
    });

    return copy;
  }, [years, sortKey, sortOrder]);

  // Pagination
  const visibleYears = showAll ? sorted : sorted.slice(0, pageSize);
  const totalPages = Math.ceil(sorted.length / pageSize);

  const toggleSort = (key: SortKey) => {
    if (sortKey === key) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortKey(key);
      setSortOrder('asc');
    }
  };

  const SortIcon = ({ k }: { k: SortKey }) => {
    if (sortKey !== k) return <span className="text-gray-300">‚¨ç</span>;
    return sortOrder === 'asc' ? <span className="text-blue-600">‚ñ≤</span> : <span className="text-blue-600">‚ñº</span>;
  };

  return (
    <div className="space-y-4">
      {/* Controls */}
      <div className="flex justify-between items-center flex-wrap gap-4">
        <div className="space-x-2">
          <button
            onClick={() => setShowAll(!showAll)}
            className="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300"
          >
            {showAll ? 'Show Per-Page' : 'Show All'}
          </button>
          {!showAll && (
            <select
              value={pageSize}
              onChange={(e) => setPageSize(Number(e.target.value))}
              className="px-2 py-1 text-sm border rounded"
            >
              <option value={10}>10 rows/page</option>
              <option value={20}>20 rows/page</option>
              <option value={40}>All years</option>
            </select>
          )}
        </div>
        <button
          onClick={() => exportProjectionCSV(sorted)}
          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm"
        >
          üì• Export CSV
        </button>
      </div>

      {/* Table */}
      <div className="overflow-x-auto">
        <table className="w-full border-collapse text-sm">
          <thead>
            <tr className="bg-gray-100 border-b sticky top-0">
              <th
                className="text-left px-3 py-2 font-semibold cursor-pointer hover:bg-gray-200"
                onClick={() => toggleSort('year')}
              >
                Year {sortKey === 'year' && <SortIcon k="year" />}
              </th>
              <th
                className="text-right px-3 py-2 font-semibold cursor-pointer hover:bg-gray-200"
                onClick={() => toggleSort('age')}
              >
                Age {sortKey === 'age' && <SortIcon k="age" />}
              </th>
              <th className="text-right px-3 py-2 font-semibold">Annuity</th>
              <th className="text-right px-3 py-2 font-semibold">FERS Suppl</th>
              <th className="text-right px-3 py-2 font-semibold">Social Sec</th>
              <th className="text-right px-3 py-2 font-semibold">TSP Draw</th>
              <th
                className="text-right px-3 py-2 font-semibold cursor-pointer hover:bg-gray-200"
                onClick={() => toggleSort('income')}
              >
                Gross Income {sortKey === 'income' && <SortIcon k="income" />}
              </th>
              <th
                className="text-right px-3 py-2 font-semibold cursor-pointer hover:bg-gray-200"
                onClick={() => toggleSort('tax')}
              >
                Total Tax {sortKey === 'tax' && <SortIcon k="tax" />}
              </th>
              <th
                className="text-right px-3 py-2 font-semibold cursor-pointer hover:bg-gray-200"
                onClick={() => toggleSort('afterTax')}
              >
                After-Tax {sortKey === 'afterTax' && <SortIcon k="afterTax" />}
              </th>
              <th className="text-right px-3 py-2 font-semibold">Expenses</th>
              <th
                className="text-right px-3 py-2 font-semibold cursor-pointer hover:bg-gray-200"
                onClick={() => toggleSort('surplus')}
              >
                Surplus {sortKey === 'surplus' && <SortIcon k="surplus" />}
              </th>
              <th
                className="text-right px-3 py-2 font-semibold cursor-pointer hover:bg-gray-200"
                onClick={() => toggleSort('balance')}
              >
                TSP Balance {sortKey === 'balance' && <SortIcon k="balance" />}
              </th>
            </tr>
          </thead>
          <tbody>
            {visibleYears.map((year, idx) => {
              const deficitRow = year.surplus < 0;
              const tspGrowthRow = idx > 0 && year.totalTSPBalance > visibleYears[idx - 1].totalTSPBalance;

              return (
                <tr
                  key={year.year}
                  className={`border-b ${
                    deficitRow ? 'bg-red-50 hover:bg-red-100' : tspGrowthRow ? 'bg-green-50' : 'hover:bg-gray-50'
                  }`}
                >
                  <td className="px-3 py-2 font-medium text-gray-900">{year.year}</td>
                  <td className="text-right px-3 py-2">{Math.round(year.age)}</td>
                  <td className="text-right px-3 py-2 tabular-nums">${fmt(year.annuity)}</td>
                  <td className="text-right px-3 py-2 tabular-nums">${fmt(year.fersSupplement)}</td>
                  <td className="text-right px-3 py-2 tabular-nums">${fmt(year.socialSecurity)}</td>
                  <td className="text-right px-3 py-2 tabular-nums">${fmt(year.tspWithdrawal)}</td>
                  <td className="text-right px-3 py-2 tabular-nums font-medium">${fmt(year.totalIncome)}</td>
                  <td className="text-right px-3 py-2 tabular-nums text-red-700">
                    ${fmt(year.federalTax + year.stateTax + year.irmaaSurcharge)}
                  </td>
                  <td className="text-right px-3 py-2 tabular-nums font-medium">${fmt(year.afterTaxIncome)}</td>
                  <td className="text-right px-3 py-2 tabular-nums">${fmt(year.totalExpenses)}</td>
                  <td
                    className={`text-right px-3 py-2 tabular-nums font-semibold ${
                      deficitRow ? 'text-red-700' : 'text-green-700'
                    }`}
                  >
                    ${fmt(year.surplus)}
                  </td>
                  <td className="text-right px-3 py-2 tabular-nums">${fmt(year.totalTSPBalance)}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* Pagination info */}
      {!showAll && (
        <div className="text-sm text-gray-600 flex justify-between items-center">
          <span>
            Showing {Math.min(pageSize, sorted.length)} of {sorted.length} years
          </span>
          {totalPages > 1 && (
            <div className="space-x-2">
              {Array.from({ length: totalPages }, (_, i) => (
                <button
                  key={i + 1}
                  onClick={() => {
                    // Scroll to top or handle page change
                  }}
                  className={`px-2 py-1 rounded ${
                    i === 0 ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300'
                  }`}
                >
                  {i + 1}
                </button>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Print hint */}
      <div className="mt-6 pt-4 border-t text-xs text-gray-500">
        <p>üí° Tip: Use your browser's print function (Ctrl+P / Cmd+P) to save as PDF.</p>
      </div>
    </div>
  );
}

function fmt(n: number): string {
  return Math.round(n).toLocaleString('en-US');
}
```

---

#### 3. `app/src/styles/print.css` (Create)
**Purpose:** Print-optimized stylesheet (hides nav, forms; makes table print-friendly).

```css
@media print {
  /* Hide interactive elements */
  header,
  nav,
  .navbar,
  .sidebar,
  .form-shell,
  button,
  input,
  select,
  textarea,
  .chart-controls,
  .export-button,
  .no-print {
    display: none !important;
  }

  /* Page setup */
  html,
  body {
    margin: 0;
    padding: 0;
    background: white;
    color: black;
  }

  body {
    font-family: 'Georgia', serif;
    font-size: 11pt;
    line-height: 1.4;
  }

  /* Main content */
  main,
  .content {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 0.5in;
  }

  /* Page breaks */
  .page-break {
    page-break-after: always;
  }

  h1,
  h2 {
    page-break-after: avoid;
  }

  table {
    page-break-inside: avoid;
  }

  tr {
    page-break-inside: avoid;
  }

  /* Table styling for print */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1em;
  }

  th,
  td {
    border: 1px solid #999;
    padding: 0.2em 0.4em;
    text-align: left;
    font-size: 10pt;
  }

  th {
    background-color: #f0f0f0;
    font-weight: bold;
  }

  /* Summary cards: display as 2-column table in print */
  .summary-panel {
    display: table;
    width: 100%;
    margin-bottom: 1em;
  }

  .metric-card {
    display: table-cell;
    width: 50%;
    padding: 0.5em;
    border: 1px solid #ccc;
  }

  /* Remove colors; use grayscale */
  * {
    color: black !important;
    background: white !important;
    box-shadow: none !important;
  }

  a {
    text-decoration: underline;
    color: black !important;
  }

  /* Chart placeholders: show title only */
  canvas,
  svg,
  .recharts-surface {
    display: none;
  }

  .chart-title-only::before {
    content: attr(data-chart-name);
    font-weight: bold;
    display: block;
    margin: 1em 0 0.5em 0;
  }

  /* Footer with URL */
  body::after {
    content: 'Generated from FedRetire retirement planning tool';
    display: block;
    margin-top: 2em;
    padding-top: 1em;
    border-top: 1px solid #999;
    font-size: 9pt;
    color: #666;
  }

  /* Margins */
  @page {
    margin: 0.5in;
  }
}
```

---

#### 4. `app/src/components/layout/Dashboard.tsx` (Edit)
**Purpose:** Add "Reports" tab to dashboard navigation; integrate ProjectionTable and export buttons.

**Changes:**
- Add "Reports" to dashboard sub-tabs (alongside Income, TSP, Expenses, Compliance, Summary)
- When Reports tab is active, render ProjectionTable
- Add secondary button: "Print Preview" ‚Üí calls `triggerPrint()`

**Pseudo-code:**
```tsx
const dashboardTabs = ['Summary', 'Income', 'TSP', 'Expenses', 'Compliance', 'Reports'];

function Dashboard() {
  const [activeTab, setActiveTab] = useState('Summary');

  return (
    <div>
      <TabBar tabs={dashboardTabs} active={activeTab} onSelect={setActiveTab} />

      {activeTab === 'Summary' && <SummaryPanel />}
      {activeTab === 'Income' && <IncomeChart />}
      {activeTab === 'Reports' && (
        <div className="space-y-4">
          <div className="flex gap-2">
            <button
              onClick={() => exportProjectionCSV(simulationData.years)}
              className="px-4 py-2 bg-green-600 text-white rounded-lg"
            >
              üì• Export CSV
            </button>
            <button
              onClick={() => triggerPrint('FedRetire Retirement Projection')}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg"
            >
              üñ®Ô∏è Print / PDF
            </button>
          </div>
          <ProjectionTable years={simulationData.years} />
        </div>
      )}
      {/* ... other tabs */}
    </div>
  );
}
```

---

#### 5. `app/src/components/scenarios/ScenarioComparison.tsx` (Edit)
**Purpose:** Add export buttons to scenario comparison view (from PR-005).

**Add to component:**
```tsx
<div className="flex gap-2 mb-4">
  <button
    onClick={() => exportScenarioJSON(baseline)}
    className="px-3 py-1 text-sm bg-gray-600 text-white rounded"
  >
    üì• Export Baseline
  </button>
  <button
    onClick={() => exportScenarioJSON(selected)}
    className="px-3 py-1 text-sm bg-gray-600 text-white rounded"
  >
    üì• Export Comparison
  </button>
  <button
    onClick={() => exportScenariosJSON([baseline, selected])}
    className="px-3 py-1 text-sm bg-gray-600 text-white rounded"
  >
    üì• Export Both
  </button>
</div>
```

---

#### 6. `app/src/components/scenarios/ScenarioManager.tsx` (Edit)
**Purpose:** Add export buttons to scenario list (from PR-005).

**Add to component:**
```tsx
<div className="flex gap-2 mb-4">
  <button
    onClick={() => exportScenariosJSON(scenarios)}
    className="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm"
  >
    üì• Export All Scenarios
  </button>
</div>
```

---

#### 7. `app/src/pages/index.astro` (Edit)
**Purpose:** Import print stylesheet.

**Add to head:**
```astro
<link rel="stylesheet" href="/styles/print.css" />
```

Or import in main Astro layout file.

---

#### 8. `app/tests/unit/export.test.ts` (Create)
**Purpose:** Unit tests for export utilities.

**Test cases:**

```typescript
describe('exportProjectionCSV', () => {
  test('Generates valid CSV with headers and data rows', () => {
    const mockYears: SimulationYearResult[] = [
      {
        year: 2027,
        age: 57.0,
        annuity: 27900,
        fersSupplement: 12300,
        socialSecurity: 0,
        tspWithdrawal: 18000,
        totalIncome: 58200,
        federalTax: 6420,
        stateTax: 0,
        irmaaSurcharge: 0,
        afterTaxIncome: 51780,
        totalExpenses: 54000,
        surplus: -2220,
        totalTSPBalance: 723456,
        // ... other fields
      },
    ];

    let csvContent = '';
    const mockTrigger = (content: string) => {
      csvContent = content;
    };

    // Spy on triggerDownload or call directly
    exportProjectionCSV(mockYears);

    expect(csvContent).toContain('Year,Age,Annuity');
    expect(csvContent).toContain('2027,57,27900');
  });

  test('Formats currency values without $ and commas in CSV', () => {
    // CSV should have plain numbers for machine readability
    const mockYears = [
      { year: 2027, age: 57, totalIncome: 58200, /* ... */ },
    ];
    const csv = generateCSV(mockYears);
    expect(csv).toContain('58200'); // not $58,200
  });

  test('Handles zero and negative surplus correctly', () => {
    const mockYears = [
      { year: 2027, surplus: 0, /* ... */ },
      { year: 2028, surplus: -5000, /* ... */ },
    ];
    const csv = generateCSV(mockYears);
    expect(csv).toContain('0\n');
    expect(csv).toContain('-5000');
  });
});

describe('exportScenarioJSON', () => {
  test('Exports scenario as valid JSON', () => {
    const mockScenario: NamedScenario = {
      id: 'test-id',
      label: 'Test Scenario',
      createdAt: '2026-02-18',
      inputs: mockSimulationInput,
      result: mockFullSimulationResult,
      isBaseline: true,
    };

    let jsonContent = '';
    const mockTrigger = (content: string) => {
      jsonContent = content;
    };

    exportScenarioJSON(mockScenario);

    const parsed = JSON.parse(jsonContent);
    expect(parsed.id).toBe('test-id');
    expect(parsed.label).toBe('Test Scenario');
  });
});

describe('triggerDownload', () => {
  test('Creates blob and triggers download', () => {
    const createElementSpy = jest.spyOn(document, 'createElement');
    const appendChildSpy = jest.spyOn(document.body, 'appendChild');
    const clickSpy = jest.fn();

    triggerDownload('test content', 'text/plain', 'test.txt');

    expect(createElementSpy).toHaveBeenCalledWith('a');
    expect(appendChildSpy).toHaveBeenCalled();
    // Verify link.click was called (may not be directly spyable)
  });

  test('Revokes object URL after download', () => {
    const revokeSpy = jest.spyOn(URL, 'revokeObjectURL');
    triggerDownload('test', 'text/plain', 'test.txt');
    expect(revokeSpy).toHaveBeenCalled();
  });
});

describe('triggerPrint', () => {
  test('Calls window.print', () => {
    const printSpy = jest.spyOn(window, 'print').mockImplementation(() => {});
    triggerPrint();
    expect(printSpy).toHaveBeenCalled();
  });

  test('Sets document title if provided', () => {
    const oldTitle = document.title;
    triggerPrint('Custom Title');
    // Title is restored after print
    expect(document.title).toBe(oldTitle); // in actual impl, would be restored
  });
});
```

---

#### 9. `app/tests/unit/components/ProjectionTable.test.tsx` (Create)
**Purpose:** Unit tests for ProjectionTable component.

**Test cases:**

```typescript
describe('ProjectionTable', () => {
  const mockYears = Array.from({ length: 40 }, (_, i) => ({
    year: 2027 + i,
    age: 57 + i,
    annuity: 27900,
    fersSupplement: 12300,
    socialSecurity: Math.min(24000, Math.max(0, (i - 5) * 2000)), // starts at year 5
    tspWithdrawal: 18000,
    totalIncome: 58200 + i * 500,
    federalTax: 6420 + i * 100,
    stateTax: 0,
    irmaaSurcharge: i > 15 ? 50 * (i - 15) : 0,
    afterTaxIncome: 51780,
    totalExpenses: 54000,
    surplus: i < 30 ? 5000 : -10000,
    totalTSPBalance: 723456 - i * 20000,
    // ... other fields
  }));

  test('Renders table with all years', () => {
    render(<ProjectionTable years={mockYears} />);
    const rows = screen.getAllByRole('row');
    // Header + 10 default rows (pageSize=10)
    expect(rows).toHaveLength(11);
  });

  test('Shows all rows when showAll clicked', async () => {
    render(<ProjectionTable years={mockYears} />);
    const showAllBtn = screen.getByText('Show All');
    fireEvent.click(showAllBtn);
    const rows = screen.getAllByRole('row');
    expect(rows).toHaveLength(41); // header + 40 years
  });

  test('Sorts by year ascending by default', () => {
    render(<ProjectionTable years={mockYears} />);
    const yearCells = screen.getAllByRole('cell').slice(1, 40, 14); // every 14th cell is year col
    expect(yearCells[0]).toHaveTextContent('2027');
  });

  test('Toggles sort order when column clicked twice', async () => {
    render(<ProjectionTable years={mockYears} />);
    const yearHeader = screen.getByText(/Year/);
    fireEvent.click(yearHeader);
    fireEvent.click(yearHeader);
    // Now should be descending
    const rows = screen.getAllByRole('row');
    expect(rows[rows.length - 1]).toHaveTextContent('2027'); // last year now at bottom
  });

  test('Highlights deficit rows in red', () => {
    const yearsWithDeficit = mockYears.map((y, i) => ({
      ...y,
      surplus: i === 5 ? -1000 : 5000,
    }));
    render(<ProjectionTable years={yearsWithDeficit} />);
    const deficitRow = screen.getByRole('row').querySelector('[class*="red-50"]');
    expect(deficitRow).toBeInTheDocument();
  });

  test('Export CSV button exported when clicked', async () => {
    const exportSpy = jest.spyOn({ exportProjectionCSV }, 'exportProjectionCSV');
    render(<ProjectionTable years={mockYears} />);
    const exportBtn = screen.getByText(/Export CSV/);
    fireEvent.click(exportBtn);
    expect(exportSpy).toHaveBeenCalledWith(mockYears);
  });

  test('Pagination controls display correct page count', () => {
    render(<ProjectionTable years={mockYears} />);
    const pageBtns = screen.getAllByRole('button').filter((b) => /^[0-9]+$/.test(b.textContent ?? ''));
    expect(pageBtns).toHaveLength(4); // 40 years / 10 per page
  });
});
```

---

#### 10. `app/src/utils/index.ts` (Edit - if barrel export)
**Purpose:** Export export utilities.

```typescript
export * from './export';
```

---

### Data Models Summary

**New utilities in `utils/export.ts`:**
- `exportProjectionCSV(years, filename?): void`
- `exportScenarioJSON(scenario, filename?): void`
- `exportScenariosJSON(scenarios, filename?): void`
- `triggerDownload(content, mimeType, filename): void`
- `triggerPrint(title?): void`

**New component in `components/charts/ProjectionTable.tsx`:**
- Sortable, paginated table of 40 years of projection data
- Export to CSV button
- Mobile-friendly horizontal scroll

**New stylesheet:**
- `styles/print.css` with `@media print` rules

---

### Integration Points

#### 1. **Dashboard Reports Tab**
- User clicks "Dashboard" ‚Üí "Reports" sub-tab
- ProjectionTable displays all 40 years
- User can sort by any column, paginate, or show all
- Export CSV button triggers CSV download
- Print button opens browser print dialog (uses print.css)

#### 2. **Scenario Export**
- User selects scenario in ScenarioManager or ScenarioComparison
- Click "Export" ‚Üí JSON file downloads
- Contains: id, label, inputs (all form data), result (full simulation result)
- Filename: `scenario-{label}-{date}.json`

#### 3. **Print Layout**
- User presses Ctrl+P / Cmd+P (or clicks "Print" button)
- Print preview opens
- print.css hides nav, forms, charts
- Shows only: title, summary card values, projection table
- "Save as PDF" from print dialog

---

### CSV Format Specification

**Headers (13 columns):**
```
Year,Age,Annuity,FERS Supplement,Social Security,TSP Withdrawal,Gross Income,Federal Tax,State Tax,IRMAA Surcharge,After-Tax Income,Total Expenses,Net Surplus,TSP Balance (EOY)
```

**Sample row:**
```
2027,57,27900,12300,0,18000,58200,6420,0,0,51780,54000,-2220,723456
```

**Notes:**
- All currency values are whole numbers (no cents)
- No $ or comma formatting (machine-readable)
- Columns match projection table display
- Can be imported into Excel, Google Sheets, or Python analysis tools

---

### JSON Scenario Format

```json
{
  "id": "uuid-123",
  "label": "Retire at 57",
  "createdAt": "2026-02-18",
  "description": "Conservative plan",
  "isBaseline": true,
  "updatedAt": "2026-02-18",
  "inputs": {
    "personalInfo": { "name": "John Doe", "birthDate": "1970-02-18", ... },
    "careerProfile": { "gsSeries": 15, "step": 10, ... },
    "expenseProfile": { "categories": [...], ... },
    "taxProfile": { "filingStatus": "married-joint", "stateCode": "VA", ... },
    "simulationConfig": { "retirementAge": 57, ... }
  },
  "result": {
    "depletionAge": null,
    "balanceAt85": 723456,
    "totalLifetimeIncome": 1847569,
    "totalLifetimeTax": 187450,
    "totalLifetimeAfterTaxIncome": 1660119,
    "years": [ { "year": 2027, "age": 57, ... }, ... ]
  }
}
```

---

### Critical Details

1. **CSV machine-readability:** All currency values are unformatted integers (no $, no commas). This allows external tools to parse easily.

2. **Print CSS strategy:** Use `@media print` to hide non-essential elements. No JavaScript required for print. User triggers via browser Ctrl+P / Cmd+P.

3. **PDF generation:** Browser's built-in print-to-PDF handles this. No third-party PDF library needed.

4. **Filename conventions:**
   - CSV: `retirement-projection-2026-02-18.csv` (date based)
   - Scenario JSON: `scenario-retire-at-57-2026-02-18.json` (label-based + date)
   - Multi-scenario JSON: `scenarios-2026-02-18.json`

5. **Table pagination:** Default 10 rows/page; user can change to 20 or "All". Shows pagination controls at bottom.

6. **Sorting:** Click column headers to sort; click again to reverse. Default sort is by Year ascending.

7. **Row highlighting:** Deficit rows (surplus < 0) shown in light red. TSP growth rows (balance increases) shown in light green.

---

### Testing Plan

1. **Manual tests:**
   - View Reports tab ‚Üí ProjectionTable displays correctly
   - Click column headers ‚Üí sorts and reverses correctly
   - Change page size ‚Üí pagination updates
   - Click "Show All" ‚Üí displays all 40 years
   - Click "Export CSV" ‚Üí file downloads with correct headers and data
   - Press Ctrl+P ‚Üí print preview shows table only (no nav/forms)
   - Select scenario ‚Üí click Export ‚Üí JSON file downloads
   - Open exported JSON in text editor ‚Üí valid syntax

2. **Unit tests:**
   - `exportProjectionCSV()` produces valid CSV
   - `exportScenarioJSON()` produces valid JSON
   - `ProjectionTable` sorts correctly by each column
   - `ProjectionTable` paginates correctly
   - Highlighting logic for deficit/growth rows

3. **Integration:**
   - Print CSS hides all interactive elements
   - Projection table readable in printed output
   - Summary cards visible in print (optional: show as 2-column layout)

4. **Regression:**
   - All existing 446 unit tests + 18 scenario tests still pass
   - No impact on other views (My Plan, Tax, Leave, Dashboard, Scenarios)

---

### Files Affected

| File | Action | Depends On |
|---|---|---|
| `utils/export.ts` | Create | (no deps) |
| `components/charts/ProjectionTable.tsx` | Create | models/simulation.ts |
| `styles/print.css` | Create | (no deps) |
| `components/layout/Dashboard.tsx` | Edit ‚Äî add Reports tab | all above |
| `components/scenarios/ScenarioComparison.tsx` | Edit ‚Äî add export btns | export utils |
| `components/scenarios/ScenarioManager.tsx` | Edit ‚Äî add export btns | export utils |
| `pages/index.astro` | Edit ‚Äî import print.css | (no deps) |
| `tests/unit/export.test.ts` | Create | utils/export.ts |
| `tests/unit/components/ProjectionTable.test.tsx` | Create | components/charts/ProjectionTable.tsx |
| `utils/index.ts` | Edit (barrel export) | utils/export.ts |

---

### Verification Checklist

- [ ] Run `pnpm typecheck` ‚Äî no errors
- [ ] Run `pnpm build` ‚Äî succeeds
- [ ] Run `pnpm test` ‚Äî existing tests pass + new export tests pass (‚â• 90% coverage)
- [ ] Manual test: open Reports tab ‚Üí table displays
- [ ] Manual test: click column header ‚Üí sorts correctly
- [ ] Manual test: click "Export CSV" ‚Üí file downloads, can open in Excel
- [ ] Manual test: click "Export Scenario" ‚Üí JSON file downloads, valid syntax
- [ ] Manual test: press Ctrl+P ‚Üí print preview shows table only, no nav
- [ ] Manual test: "Save as PDF" from print dialog ‚Üí PDF readable
- [ ] TypeScript strict mode passes with 0 errors
- [ ] All 446 existing unit tests + 18 scenario tests pass

---

### Notes on Scope

**In scope for PR-006:**
- CSV export of full projection table (40 years √ó 13 columns)
- JSON export of scenarios (for backup/sharing)
- ProjectionTable component (sortable, paginated, searchable)
- Print-optimized CSS (hides nav, forms, charts)
- PDF generation via browser print
- Export buttons in Dashboard, Scenarios views

**Out of scope (for future PRs):**
- Custom report templates (V1+)
- Email export (never; local-only policy)
- Charts in exports (V1+ if needed)
- Historical export log (V2+)
- Multi-file ZIP export (future enhancement)

---

### Dependencies & Blockers

- **PR-006 depends on:** PR-003 (tax integration), PR-005 (scenario management)
- **PR-006 is depended on by:** None (provides export capability to earlier features)
- **Can start:** After PR-005 complete

---

### Success Criteria

- ‚úì ProjectionTable component displays full 40-year projection with all key metrics
- ‚úì Sortable columns (click header to sort ascending/descending)
- ‚úì Paginated display (default 10 rows/page, configurable, "Show All" option)
- ‚úì Deficit rows highlighted in red; growth rows highlighted in green
- ‚úì Export CSV button downloads valid CSV file with correct headers and data
- ‚úì Export Scenario JSON button downloads scenario as valid JSON
- ‚úì Export All Scenarios button downloads multiple scenarios as JSON array
- ‚úì Browser print dialog (Ctrl+P) uses print.css to hide nav/forms/charts
- ‚úì Print output readable and single-column layout
- ‚úì "Save as PDF" from print dialog produces valid PDF
- ‚úì Print CSS works on Chrome, Firefox, Safari, Edge
- ‚úì All exported files are valid and re-importable
- ‚úì Reports tab added to Dashboard
- ‚úì Export buttons present in Dashboard, Scenarios, ScenarioComparison views
- ‚úì TypeScript strict mode passes with 0 errors
- ‚úì All 446 existing unit tests + 18 scenario tests still pass
- ‚úì New export and ProjectionTable tests ‚â• 90% branch coverage

