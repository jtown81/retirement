# PR-004: TSP Monitoring — Balance History & Fund Allocation — Plan

## Context

We've completed the tax module and TaxProfileForm (PR-001, PR-002, PR-003). Now we need to add TSP account monitoring: the ability to track balance history, enter fund allocations (G/F/C/S/I/L), and import TSP.gov CSV account statements.

Currently, the app accepts a point-in-time TSP balance. With PR-004, users can:
1. Record multiple snapshots of their TSP balance over time
2. Specify fund allocation (what % is in each fund, for both Traditional and Roth)
3. Import account activity CSV from TSP.gov to auto-populate balances and transactions
4. View balance history and fund allocation in a visual donut chart

This feeds into future PRs for Monte Carlo analysis and withdrawal sequencing.

## Implementation Plan

### Files to Create/Modify

#### 1. `app/src/models/tsp.ts` (Edit)
- Add new types:
  - `TSPFundCode`: union of fund codes (G, F, C, S, I, L-Income, L2025, L2030, L2035, L2040, L2045, L2050, L2055, L2060, L2065)
  - `TSPFundAllocation`: `{ fund: TSPFundCode, percentTraditional: number, percentRoth: number }`
  - `TSPAccountSnapshot`: `{ id, asOf, source: 'manual' | 'csv-import', traditionalBalance, rothBalance, ytdEmployeeContributions, ytdAgencyContributions, fundAllocations: TSPFundAllocation[], notes?: string }`
  - `TSPTransactionRow`: `{ date, description, source: 'employee' | 'agency-auto' | 'agency-match' | 'earnings' | 'withdrawal' | 'other', amount, runningBalance }`
  - `TSPImportError`: `{ type: 'parse-error' | 'validation-error', message: string, row?: number }`

#### 2. `app/src/storage/schema.ts` (Edit)
- Add `TSP_SNAPSHOTS: 'retire:tsp:snapshots'` to STORAGE_KEYS
- Update `CURRENT_SCHEMA_VERSION` if not already at 2

#### 3. `app/src/storage/zod-schemas.ts` (Edit)
- Add Zod schemas:
  - `TSPFundCodeSchema`
  - `TSPFundAllocationSchema`
  - `TSPAccountSnapshotSchema`
  - `TSPTransactionRowSchema`

#### 4. `app/src/storage/index.ts` (Edit)
- Export the new schemas from zod-schemas.ts

#### 5. `app/src/modules/tsp/import.ts` (Create)
**Purpose:** Parse TSP.gov account activity CSV and validate format.

**Key functions:**
- `parseTSPCSV(rawText: string): TSPTransactionRow[] | TSPImportError` — main parser
- `mapTSPFund(fundName: string): TSPFundCode | null` — map "G Fund" → "G"
- `parseMMDDYYYY(dateStr: string): ISODate` — parse date format from CSV
- `mapTransactionSource(sourceStr: string): 'employee' | 'agency-auto' | 'agency-match' | 'earnings' | 'withdrawal' | 'other'`

**Expected CSV format** (from TSP.gov account activity export):
```
Date,Transaction Description,Fund,Source,Amount,Share Price,Shares,Running Balance
"04/15/2024","Agency Auto (k)",C Fund,Agency Auto,100.00,123.45,0.811,25000.00
"04/20/2024","Employee Contribution",G Fund,Employee,50.00,100.00,0.500,25050.00
```

**Error handling:**
- If headers don't match, return `{ type: 'parse-error', message: 'Unexpected CSV format...', row: 0 }`
- If unknown fund code, return `{ type: 'parse-error', message: 'Unknown fund: XYZ', row: 2 }`
- If amount can't parse as number, return validation error

#### 6. `app/src/components/forms/TSPMonitorPanel.tsx` (Create)
**Purpose:** Display balance history table and provide "Add Snapshot" / "Import CSV" buttons.

**Structure:**
- Uses `useLocalStorage(STORAGE_KEYS.TSP_SNAPSHOTS, z.array(TSPAccountSnapshotSchema))`
- **Table columns:**
  - As Of Date
  - Traditional Balance
  - Roth Balance
  - Total Balance
  - Source (Manual / CSV Import)
  - Fund Allocation (summary: "G 20% / F 30% / C 50%")
  - Actions (Edit / Delete)
- **Buttons:**
  - "Add Snapshot Manually" → opens `AddSnapshotModal`
  - "Import TSP CSV" → opens `TSPImportModal`
- **Sorting:** newest first
- **Empty state:** "No snapshots recorded. Add your first TSP balance to enable balance tracking."

#### 7. `app/src/components/forms/AddSnapshotModal.tsx` (Create)
**Purpose:** Form to manually add a TSP account snapshot.

**Fields:**
- **As Of Date** (date input): ISO date
- **Traditional Balance** ($): number input
- **Roth Balance** ($): number input
- **YTD Employee Contributions** ($): number input (optional)
- **YTD Agency Contributions** ($): number input (optional)
- **Fund Allocation** (sliders or radio group per fund):
  - For each fund (G, F, C, S, I, L-[target date]):
    - Traditional %: slider 0–100
    - Roth %: slider 0–100
    - Total for fund must equal 100% across Traditional + Roth
- **Notes** (textarea, optional)
- **Save** button: validates, adds to snapshots, closes modal
- **Cancel** button

**Validation:**
- All fund allocations must sum to 100% (Traditional + Roth combined)
- As Of Date must be valid ISO date
- Balances must be non-negative

#### 8. `app/src/components/forms/TSPImportModal.tsx` (Create)
**Purpose:** File picker, CSV parser, preview, and confirmation dialog.

**Workflow:**
1. **File picker:** User selects TSP account activity CSV from their machine
2. **Parse:** Call `parseTSPCSV(rawText)` on file contents
3. **Preview:**
   - If parse error: show error message with row number and suggestion
   - If success: show table of parsed transactions (first 10 rows)
     - Columns: Date, Description, Fund, Source, Amount, Running Balance
4. **Extract snapshot:** From the last transaction, auto-populate:
   - As Of Date: last transaction date
   - Running Balance (sum by fund if possible, or total)
   - Source: 'csv-import'
5. **Confirmation:** "Import X transactions and create snapshot?" with Cancel/Confirm
6. **Save:** On confirm, add snapshot + optionally store transaction history for future analysis

**Error UI:**
- Red alert box with error message
- Row number (if available) with suggestion to check format
- "Download expected format" link to template CSV (future feature)

#### 9. `app/src/components/charts/TSPFundDonut.tsx` (Create)
**Purpose:** Donut chart of fund allocation from latest snapshot.

**Data:**
- Latest snapshot → fundAllocations array
- Group by fund code (ignoring Traditional vs Roth for initial MVP)
- Show percentages for each fund

**Display:**
- Donut chart using Recharts
- Tooltip: "G Fund: 20%"
- Legend below
- Center text: "Fund Allocation (Latest Snapshot)"
- Empty state: "No fund allocations recorded"

**Responsive:** Mobile-friendly sizing

#### 10. `app/src/components/forms/FormShell.tsx` (Edit - if not already)
- If a "TSP Monitor" tab should be added to My Plan, update FormShell
- Current plan: TSP monitoring is a separate view or embedded in a TSP form tab
- **Decision:** Embed in "FERS Estimate" tab or create new "TSP Monitor" tab?
- **For PR-004:** Create new "TSP Monitor" tab for balance tracking (separate from current TSP fields in FERS form)
- Add icon: `BarChart3` or `TrendingUp` from lucide-react

#### 11. `app/src/components/PlannerApp.tsx` (Edit - if new tab added)
- Import `TSPMonitorPanel`
- Add case for 'tsp-monitor' in FormContent switch
- Update FormShell call to include new tab

#### 12. `app/tests/unit/tsp/import.test.ts` (Create)
**Test cases:**

**Valid CSV:**
- Test 1: Parse valid 3-row CSV → returns array of 3 TSPTransactionRow
- Test 2: Handle fund mapping correctly (G Fund → G, etc.)
- Test 3: Parse amounts with $ and commas correctly ($1,234.56 → 1234.56)
- Test 4: Parse dates in MM/DD/YYYY format correctly
- Test 5: Map transaction sources correctly (Employee → employee, Agency Auto → agency-auto, etc.)

**Error cases:**
- Test 6: Missing headers → returns parse-error with row 0
- Test 7: Unknown fund code → returns parse-error with row number
- Test 8: Invalid amount format → returns parse-error
- Test 9: Empty file → returns empty array
- Test 10: BOM-prefixed CSV (from some Excel exports) → strips BOM and parses correctly

**Edge cases:**
- Test 11: Very large running balance (over $1M) → parses correctly
- Test 12: Negative amount (withdrawal) → handled correctly
- Test 13: Zero amount row → allowed
- Test 14: Multiple funds per transaction row → parsed correctly

### Data Models Summary

```typescript
// models/tsp.ts additions
export type TSPFundCode = 'G' | 'F' | 'C' | 'S' | 'I'
  | 'L-Income' | 'L2025' | 'L2030' | 'L2035' | 'L2040'
  | 'L2045' | 'L2050' | 'L2055' | 'L2060' | 'L2065';

export interface TSPFundAllocation {
  fund: TSPFundCode;
  percentTraditional: number;  // 0–100
  percentRoth: number;         // 0–100 (must sum to 100)
}

export interface TSPAccountSnapshot {
  id: string;                  // crypto.randomUUID()
  asOf: ISODate;               // YYYY-MM-DD
  source: 'manual' | 'csv-import';
  traditionalBalance: USD;
  rothBalance: USD;
  ytdEmployeeContributions?: USD;
  ytdAgencyContributions?: USD;
  fundAllocations: TSPFundAllocation[];
  notes?: string;
}

export interface TSPTransactionRow {
  date: ISODate;
  description: string;
  source: 'employee' | 'agency-auto' | 'agency-match' | 'earnings' | 'withdrawal' | 'other';
  amount: number;              // positive = deposit, negative = withdrawal
  runningBalance: number;
}

export type TSPImportError =
  | { type: 'parse-error'; message: string; row?: number }
  | { type: 'validation-error'; message: string };
```

### Storage & Defaults

**Storage key:**
```typescript
STORAGE_KEYS.TSP_SNAPSHOTS: 'retire:tsp:snapshots'
```

**Default (new user):**
Empty array `[]` until user adds first snapshot.

**Migration (v1 → v2):**
- If user has `TSP_BALANCES` (old key), optionally migrate to first snapshot with source='manual'
- Optional for MVP; can skip in PR-004

### Critical Details

1. **Fund allocation validation:** When user moves sliders, total Traditional + Roth for all funds must = 100%. Use `sum()` to verify on save.

2. **CSV format compatibility:** TSP.gov exports may vary by export type. Start with "Account Activity" format only; document expected format clearly.

3. **Snapshot IDs:** Use `crypto.randomUUID()` if available; fallback to `${Date.now()}-${Math.random().toString(36).slice(2)}`.

4. **Timezone handling:** TSP dates are in user's local TZ. Store as ISO date (just YYYY-MM-DD) without time component.

5. **Fund allocation UI complexity:** Initial MVP can use simple sliders or dropdown list with % input per fund. Future enhancement: drag-to-allocate circle UI.

6. **Import modal vs new form tab:** Decision: keep import as a modal dialog within TSPMonitorPanel rather than a separate form tab. Keeps scope tight.

### Testing Plan

1. **Load panel:** TSP Monitor tab appears; "No snapshots" message shows
2. **Add manual snapshot:**
   - Click "Add Snapshot"
   - Fill in balances and fund allocation
   - Save → snapshot appears in table
   - Reload page → snapshot persists
3. **Fund allocation sliders:**
   - Adjust G Fund Traditional % → Roth % updates to maintain 100%
   - All funds sum correctly
4. **Import CSV:**
   - Click "Import CSV"
   - Select valid TSP account activity CSV
   - Preview shows parsed rows
   - Confirm → snapshot created from last row's running balance
5. **CSV error handling:**
   - Select invalid CSV → error shown with row number
   - Fix and re-import → works
6. **Fund donut chart:**
   - Create snapshot with allocation
   - Donut chart updates with correct percentages
7. **Edit/Delete:**
   - Delete snapshot → removed from table
   - Edit snapshot → updates balances and allocation
8. **Existing tests:** 446 unit tests + 18 scenario tests still pass

### Files Affected

| File | Action | Depends On |
|---|---|---|
| `models/tsp.ts` | Edit — add types | (no deps) |
| `storage/schema.ts` | Edit — add key | (no deps) |
| `storage/zod-schemas.ts` | Edit — add schemas | (no deps) |
| `storage/index.ts` | Edit — export schemas | above |
| `modules/tsp/import.ts` | Create | models/tsp.ts |
| `components/forms/AddSnapshotModal.tsx` | Create | models/tsp.ts, storage |
| `components/forms/TSPImportModal.tsx` | Create | modules/tsp/import.ts |
| `components/forms/TSPMonitorPanel.tsx` | Create | all above |
| `components/charts/TSPFundDonut.tsx` | Create | models/tsp.ts |
| `components/forms/FormShell.tsx` | Edit — add TSP Monitor tab | (optional) |
| `components/PlannerApp.tsx` | Edit — route tab | (optional) |
| `tests/unit/tsp/import.test.ts` | Create | modules/tsp/import.ts |

### Verification

1. Run `pnpm typecheck` — no errors
2. Run `pnpm build` — succeeds
3. Run `pnpm test` — existing tests pass + new import tests pass
4. Manual test: add snapshot, import CSV, view fund donut, delete snapshot
5. DevTools: localStorage under `retire:tsp:snapshots` persists correctly

### Notes on Scope

**In scope for PR-004:**
- Manual snapshot entry
- CSV import from TSP.gov account activity export
- Balance history table
- Fund allocation UI
- Fund donut chart

**Out of scope (for future PRs):**
- Transaction history analysis (raw transaction storage for future use)
- Fund performance tracking
- Rebalancing alerts
- Integration with Monte Carlo (uses latest snapshot balance as seed)
- TSP contribution strategy UI (existing in FERS Estimate; unchanged)

### Dependencies & Blockers

- **PR-004 has no dependencies.** Can run in parallel with other work.
- **PR-005 and PR-006** may depend on TSP snapshots for scenario comparison.

### Success Criteria

- ✓ User can add manual TSP account snapshots with balance and fund allocation
- ✓ User can import TSP.gov CSV and auto-populate snapshot
- ✓ Balance history table displays snapshots sorted by date (newest first)
- ✓ Fund allocation donut chart visualizes latest snapshot
- ✓ Fund allocation validation prevents invalid allocations
- ✓ CSV parser handles expected TSP.gov format; clear error messages for invalid format
- ✓ All snapshots persist to localStorage
- ✓ 446 existing unit tests + 18 scenario tests still pass
- ✓ New import parser tests ≥ 90% branch coverage
